import { Inject, Injectable, Optional } from '@angular/core';
import { GoogleTagManagerConfiguration } from './angular-google-tag-manager-config.service';
import * as i0 from "@angular/core";
import * as i1 from "./angular-google-tag-manager-config.service";
class GoogleTagManagerService {
    constructor(googleTagManagerConfiguration, googleTagManagerId, googleTagManagerMode = "noisy", googleTagManagerAuth, googleTagManagerPreview, googleTagManagerResourcePath, googleTagManagerCSPNonce) {
        this.googleTagManagerConfiguration = googleTagManagerConfiguration;
        this.googleTagManagerId = googleTagManagerId;
        this.googleTagManagerMode = googleTagManagerMode;
        this.googleTagManagerAuth = googleTagManagerAuth;
        this.googleTagManagerPreview = googleTagManagerPreview;
        this.googleTagManagerResourcePath = googleTagManagerResourcePath;
        this.googleTagManagerCSPNonce = googleTagManagerCSPNonce;
        this.isLoaded = false;
        this.browserGlobals = {
            windowRef() {
                return window;
            },
            documentRef() {
                return document;
            },
        };
        this.config = this.googleTagManagerConfiguration?.get();
        if (this.config == null) {
            this.config = { id: null };
        }
        this.config = {
            ...this.config,
            id: googleTagManagerId || this.config.id,
            gtm_auth: googleTagManagerAuth || this.config.gtm_auth,
            gtm_preview: googleTagManagerPreview || this.config.gtm_preview,
            gtm_resource_path: googleTagManagerResourcePath || this.config.gtm_resource_path,
        };
        if (this.config.id == null) {
            return;
        }
    }
    checkForId() {
        if (this.googleTagManagerMode !== "silent" && !this.config.id) {
            throw new Error('Google tag manager ID not provided.');
        }
        else if (!this.config.id) {
            return false;
        }
        return true;
    }
    getDataLayer() {
        this.checkForId();
        const window = this.browserGlobals.windowRef();
        window.dataLayer = window.dataLayer || [];
        return window.dataLayer;
    }
    pushOnDataLayer(obj) {
        this.checkForId();
        const dataLayer = this.getDataLayer();
        dataLayer.push(obj);
    }
    addGtmToDom() {
        return new Promise((resolve, reject) => {
            if (this.isLoaded) {
                return resolve(this.isLoaded);
            }
            else if (!this.checkForId()) {
                return resolve(false);
            }
            const doc = this.browserGlobals.documentRef();
            this.pushOnDataLayer({
                'gtm.start': new Date().getTime(),
                event: 'gtm.js',
            });
            const gtmScript = doc.createElement('script');
            gtmScript.id = 'GTMscript';
            gtmScript.async = true;
            gtmScript.src = this.applyGtmQueryParams(this.config.gtm_resource_path
                ? this.config.gtm_resource_path
                : 'https://www.googletagmanager.com/gtm.js');
            gtmScript.addEventListener('load', () => {
                return resolve((this.isLoaded = true));
            });
            gtmScript.addEventListener('error', () => {
                return reject(false);
            });
            if (this.googleTagManagerCSPNonce) {
                gtmScript.setAttribute('nonce', this.googleTagManagerCSPNonce);
            }
            doc.head.insertBefore(gtmScript, doc.head.firstChild);
        });
    }
    pushTag(item) {
        return new Promise((resolve, reject) => {
            if (!this.checkForId()) {
                return resolve();
            }
            if (!this.isLoaded) {
                this.addGtmToDom()
                    .then(() => {
                    this.pushOnDataLayer(item);
                    return resolve();
                })
                    .catch(() => reject());
            }
            else {
                this.pushOnDataLayer(item);
                return resolve();
            }
        });
    }
    applyGtmQueryParams(url) {
        if (url.indexOf('?') === -1) {
            url += '?';
        }
        return (url +
            Object.keys(this.config)
                .filter((k) => this.config[k])
                .map((k) => `${k}=${this.config[k]}`)
                .join('&'));
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.0.2", ngImport: i0, type: GoogleTagManagerService, deps: [{ token: GoogleTagManagerConfiguration, optional: true }, { token: 'googleTagManagerId', optional: true }, { token: 'googleTagManagerMode', optional: true }, { token: 'googleTagManagerAuth', optional: true }, { token: 'googleTagManagerPreview', optional: true }, { token: 'googleTagManagerResourcePath', optional: true }, { token: 'googleTagManagerCSPNonce', optional: true }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.0.2", ngImport: i0, type: GoogleTagManagerService, providedIn: 'root' }); }
}
export { GoogleTagManagerService };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.0.2", ngImport: i0, type: GoogleTagManagerService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: i1.GoogleTagManagerConfiguration, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [GoogleTagManagerConfiguration]
                }] }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: ['googleTagManagerId']
                }] }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: ['googleTagManagerMode']
                }] }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: ['googleTagManagerAuth']
                }] }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: ['googleTagManagerPreview']
                }] }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: ['googleTagManagerResourcePath']
                }] }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: ['googleTagManagerCSPNonce']
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5ndWxhci1nb29nbGUtdGFnLW1hbmFnZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL2FuZ3VsYXItZ29vZ2xlLXRhZy1tYW5hZ2VyL3NyYy9saWIvYW5ndWxhci1nb29nbGUtdGFnLW1hbmFnZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDN0QsT0FBTyxFQUFFLDZCQUE2QixFQUFFLE1BQU0sNkNBQTZDLENBQUM7OztBQUc1RixNQUdhLHVCQUF1QjtJQWFsQyxZQUdTLDZCQUE0RCxFQUNsQixrQkFBMEIsRUFDeEIsdUJBQXlDLE9BQU8sRUFHNUYsb0JBQTRCLEVBRzVCLHVCQUErQixFQUcvQiw0QkFBb0MsRUFHcEMsd0JBQWdDO1FBZGhDLGtDQUE2QixHQUE3Qiw2QkFBNkIsQ0FBK0I7UUFDbEIsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFRO1FBQ3hCLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBNEI7UUFHNUYseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFRO1FBRzVCLDRCQUF1QixHQUF2Qix1QkFBdUIsQ0FBUTtRQUcvQixpQ0FBNEIsR0FBNUIsNEJBQTRCLENBQVE7UUFHcEMsNkJBQXdCLEdBQXhCLHdCQUF3QixDQUFRO1FBN0JqQyxhQUFRLEdBQUcsS0FBSyxDQUFDO1FBR2pCLG1CQUFjLEdBQUc7WUFDdkIsU0FBUztnQkFDUCxPQUFPLE1BQU0sQ0FBQztZQUNoQixDQUFDO1lBQ0QsV0FBVztnQkFDVCxPQUFPLFFBQVEsQ0FBQztZQUNsQixDQUFDO1NBQ0YsQ0FBQztRQXFCQSxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyw2QkFBNkIsRUFBRSxHQUFHLEVBQUUsQ0FBQztRQUN4RCxJQUFJLElBQUksQ0FBQyxNQUFNLElBQUksSUFBSSxFQUFFO1lBQ3ZC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QUMzQixHQUFHLElBQUksR0FBRyxDQUFDO1NBQ1o7UUFFRCxPQUFPLENBQ0wsR0FBRztZQUNILE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztpQkFDckIsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUM3QixHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztpQkFDcEMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUNiLENBQUM7SUFDSixDQUFDOzhHQTFJVSx1QkFBdUIsa0JBZXhCLDZCQUE2Qiw2QkFFakIsb0JBQW9CLDZCQUNwQixzQkFBc0IsNkJBRWxDLHNCQUFzQiw2QkFHdEIseUJBQXlCLDZCQUd6Qiw4QkFBOEIsNkJBRzlCLDBCQUEwQjtrSEE3QnpCLHVCQUF1QixjQUZ0QixNQUFNOztTQUVQLHVCQUF1QjsyRkFBdkIsdUJBQXVCO2tCQUhuQyxVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQjs7MEJBZUksUUFBUTs7MEJBQ1IsTUFBTTsyQkFBQyw2QkFBNkI7OzBCQUVwQyxRQUFROzswQkFBSSxNQUFNOzJCQUFDLG9CQUFvQjs7MEJBQ3ZDLFFBQVE7OzBCQUFJLE1BQU07MkJBQUMsc0JBQXNCOzswQkFDekMsUUFBUTs7MEJBQ1IsTUFBTTsyQkFBQyxzQkFBc0I7OzBCQUU3QixRQUFROzswQkFDUixNQUFNOzJCQUFDLHlCQUF5Qjs7MEJBRWhDLFFBQVE7OzBCQUNSLE1BQU07MkJBQUMsOEJBQThCOzswQkFFckMsUUFBUTs7MEJBQ1IsTUFBTTsyQkFBQywwQkFBMEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBHb29nbGVUYWdNYW5hZ2VyQ29uZmlndXJhdGlvbiB9IGZyb20gJy4vYW5ndWxhci1nb29nbGUtdGFnLW1hbmFnZXItY29uZmlnLnNlcnZpY2UnO1xuaW1wb3J0IHsgR29vZ2xlVGFnTWFuYWdlckNvbmZpZyB9IGZyb20gJy4vZ29vZ2xlLXRhZy1tYW5hZ2VyLWNvbmZpZyc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBHb29nbGVUYWdNYW5hZ2VyU2VydmljZSB7XG4gIHByaXZhdGUgaXNMb2FkZWQgPSBmYWxzZTtcbiAgcHJpdmF0ZSBjb25maWc6IEdvb2dsZVRhZ01hbmFnZXJDb25maWcgfCBudWxsO1xuXG4gIHByaXZhdGUgYnJvd3Nlckdsb2JhbHMgPSB7XG4gICAgd2luZG93UmVmKCk6IGFueSB7XG4gICAgICByZXR1cm4gd2luZG93O1xuICAgIH0sXG4gICAgZG9jdW1lbnRSZWYoKTogYW55IHtcbiAgICAgIHJldHVybiBkb2N1bWVudDtcbiAgICB9LFxuICB9O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBPcHRpb25hbCgpXG4gICAgQEluamVjdChHb29nbGVUYWdNYW5hZ2VyQ29uZmlndXJhdGlvbilcbiAgICBwdWJsaWMgZ29vZ2xlVGFnTWFuYWdlckNvbmZpZ3VyYXRpb246IEdvb2dsZVRhZ01hbmFnZXJDb25maWd1cmF0aW9uLFxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoJ2dvb2dsZVRhZ01hbmFnZXJJZCcpIHB1YmxpYyBnb29nbGVUYWdNYW5hZ2VySWQ6IHN0cmluZyxcbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KCdnb29nbGVUYWdNYW5hZ2VyTW9kZScpIHB1YmxpYyBnb29nbGVUYWdNYW5hZ2VyTW9kZTogXCJzaWxlbnRcInxcIm5vaXN5XCIgPSBcIm5vaXN5XCIsXG4gICAgQE9wdGlvbmFsKClcbiAgICBASW5qZWN0KCdnb29nbGVUYWdNYW5hZ2VyQXV0aCcpXG4gICAgcHVibGljIGdvb2dsZVRhZ01hbmFnZXJBdXRoOiBzdHJpbmcsXG4gICAgQE9wdGlvbmFsKClcbiAgICBASW5qZWN0KCdnb29nbGVUYWdNYW5hZ2VyUHJldmlldycpXG4gICAgcHVibGljIGdvb2dsZVRhZ01hbmFnZXJQcmV2aWV3OiBzdHJpbmcsXG4gICAgQE9wdGlvbmFsKClcbiAgICBASW5qZWN0KCdnb29nbGVUYWdNYW5hZ2VyUmVzb3VyY2VQYXRoJylcbiAgICBwdWJsaWMgZ29vZ2xlVGFnTWFuYWdlclJlc291cmNlUGF0aDogc3RyaW5nLFxuICAgIEBPcHRpb25hbCgpXG4gICAgQEluamVjdCgnZ29vZ2xlVGFnTWFuYWdlckNTUE5vbmNlJylcbiAgICBwdWJsaWMgZ29vZ2xlVGFnTWFuYWdlckNTUE5vbmNlOiBzdHJpbmdcbiAgKSB7XG4gICAgdGhpcy5jb25maWcgPSB0aGlzLmdvb2dsZVRhZ01hbmFnZXJDb25maWd1cmF0aW9uPy5nZXQoKTtcbiAgICBpZiAodGhpcy5jb25maWcgPT0gbnVsbCkge1xuICAgICAgdGhpcy5jb25maWcgPSB7IGlkOiBudWxsIH07XG4gICAgfVxuXG4gICAgdGhpcy5jb25maWcgPSB7XG4gICAgICAuLi50aGlzLmNvbmZpZyxcbiAgICAgIGlkOiBnb29nbGVUYWdNYW5hZ2VySWQgfHwgdGhpcy5jb25maWcuaWQsXG4gICAgICBndG1fYXV0aDogZ29vZ2xlVGFnTWFuYWdlckF1dGggfHwgdGhpcy5jb25maWcuZ3RtX2F1dGgsXG4gICAgICBndG1fcHJldmlldzogZ29vZ2xlVGFnTWFuYWdlclByZXZpZXcgfHwgdGhpcy5jb25maWcuZ3RtX3ByZXZpZXcsXG4gICAgICBndG1fcmVzb3VyY2VfcGF0aDpcbiAgICAgICAgZ29vZ2xlVGFnTWFuYWdlclJlc291cmNlUGF0aCB8fCB0aGlzLmNvbmZpZy5ndG1fcmVzb3VyY2VfcGF0aCxcbiAgICB9O1xuICAgIGlmICh0aGlzLmNvbmZpZy5pZCA9PSBudWxsKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjaGVja0ZvcklkKCk6IGJvb2xlYW4ge1xuICAgIGlmKCB0aGlzLmdvb2dsZVRhZ01hbmFnZXJNb2RlICE9PSBcInNpbGVudFwiICYmICF0aGlzLmNvbmZpZy5pZCApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignR29vZ2xlIHRhZyBtYW5hZ2VyIElEIG5vdCBwcm92aWRlZC4nKTtcbiAgICB9IGVsc2UgaWYoICF0aGlzLmNvbmZpZy5pZCApIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwdWJsaWMgZ2V0RGF0YUxheWVyKCk6IGFueVtdIHtcbiAgICB0aGlzLmNoZWNrRm9ySWQoKTtcbiAgICBjb25zdCB3aW5kb3cgPSB0aGlzLmJyb3dzZXJHbG9iYWxzLndpbmRvd1JlZigpO1xuICAgIHdpbmRvdy5kYXRhTGF5ZXIgPSB3aW5kb3cuZGF0YUxheWVyIHx8IFtdO1xuICAgIHJldHVybiB3aW5kb3cuZGF0YUxheWVyO1xuICB9XG5cbiAgcHJpdmF0ZSBwdXNoT25EYXRhTGF5ZXIob2JqOiBvYmplY3QpOiB2b2lkIHtcbiAgICB0aGlzLmNoZWNrRm9ySWQoKTtcbiAgICBjb25zdCBkYXRhTGF5ZXIgPSB0aGlzLmdldERhdGFMYXllcigpO1xuICAgIGRhdGFMYXllci5wdXNoKG9iaik7XG4gIH1cblxuICBwdWJsaWMgYWRkR3RtVG9Eb20oKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGlmICh0aGlzLmlzTG9hZGVkKSB7XG4gICAgICAgIHJldHVybiByZXNvbHZlKHRoaXMuaXNMb2FkZWQpO1xuICAgICAgfSBlbHNlIGlmKCAhdGhpcy5jaGVja0ZvcklkKCkgKSB7XG4gICAgICAgIHJldHVybiByZXNvbHZlKGZhbHNlKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGRvYyA9IHRoaXMuYnJvd3Nlckdsb2JhbHMuZG9jdW1lbnRSZWYoKTtcbiAgICAgIHRoaXMucHVzaE9uRGF0YUxheWVyKHtcbiAgICAgICAgJ2d0bS5zdGFydCc6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLFxuICAgICAgICBldmVudDogJ2d0bS5qcycsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgZ3RtU2NyaXB0ID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpO1xuICAgICAgZ3RtU2NyaXB0LmlkID0gJ0dUTXNjcmlwdCc7XG4gICAgICBndG1TY3JpcHQuYXN5bmMgPSB0cnVlO1xuICAgICAgZ3RtU2NyaXB0LnNyYyA9IHRoaXMuYXBwbHlHdG1RdWVyeVBhcmFtcyhcbiAgICAgICAgdGhpcy5jb25maWcuZ3RtX3Jlc291cmNlX3BhdGhcbiAgICAgICAgICA/IHRoaXMuY29uZmlnLmd0bV9yZXNvdXJjZV9wYXRoXG4gICAgICAgICAgOiAnaHR0cHM6Ly93d3cuZ29vZ2xldGFnbWFuYWdlci5jb20vZ3RtLmpzJ1xuICAgICAgKTtcbiAgICAgIGd0bVNjcmlwdC5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgKCkgPT4ge1xuICAgICAgICByZXR1cm4gcmVzb2x2ZSgodGhpcy5pc0xvYWRlZCA9IHRydWUpKTtcbiAgICAgIH0pO1xuICAgICAgZ3RtU2NyaXB0LmFkZEV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgKCkgPT4ge1xuICAgICAgICByZXR1cm4gcmVqZWN0KGZhbHNlKTtcbiAgICAgIH0pO1xuICAgICAgaWYgKHRoaXMuZ29vZ2xlVGFnTWFuYWdlckNTUE5vbmNlKSB7XG4gICAgICAgIGd0bVNjcmlwdC5zZXRBdHRyaWJ1dGUoJ25vbmNlJywgdGhpcy5nb29nbGVUYWdNYW5hZ2VyQ1NQTm9uY2UpO1xuICAgICAgfVxuICAgICAgZG9jLmhlYWQuaW5zZXJ0QmVmb3JlKGd0bVNjcmlwdCwgZG9jLmhlYWQuZmlyc3RDaGlsZCk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgcHVzaFRhZyhpdGVtOiBvYmplY3QpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgaWYoICF0aGlzLmNoZWNrRm9ySWQoKSApIHtcbiAgICAgICAgcmV0dXJuIHJlc29sdmUoKTtcbiAgICAgIH1cblxuICAgICAgaWYgKCF0aGlzLmlzTG9hZGVkKSB7XG4gICAgICAgIHRoaXMuYWRkR3RtVG9Eb20oKVxuICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMucHVzaE9uRGF0YUxheWVyKGl0ZW0pO1xuICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoKTtcbiAgICAgICAgICB9KVxuICAgICAgICAgIC5jYXRjaCgoKSA9PiByZWplY3QoKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnB1c2hPbkRhdGFMYXllcihpdGVtKTtcbiAgICAgICAgcmV0dXJuIHJlc29sdmUoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYXBwbHlHdG1RdWVyeVBhcmFtcyh1cmw6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKHVybC5pbmRleE9mKCc/JykgPT09IC0xKSB7XG4gICAgICB1cmwgKz0gJz8nO1xuICAgIH1cblxuICAgIHJldHVybiAoXG4gICAgICB1cmwgK1xuICAgICAgT2JqZWN0LmtleXModGhpcy5jb25maWcpXG4gICAgICAgIC5maWx0ZXIoKGspID0+IHRoaXMuY29uZmlnW2tdKVxuICAgICAgICAubWFwKChrKSA9PiBgJHtrfT0ke3RoaXMuY29uZmlnW2tdfWApXG4gICAgICAgIC5qb2luKCcmJylcbiAgICApO1xuICB9XG59XG4iXX0=