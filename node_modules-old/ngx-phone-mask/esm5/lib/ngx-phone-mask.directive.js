/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, ElementRef, forwardRef, HostListener, Inject, Input, Optional, Renderer2 } from '@angular/core';
import { NG_VALUE_ACCESSOR, COMPOSITION_BUFFER_MODE } from '@angular/forms';
import { ÉµgetDOM as getDOM } from '@angular/platform-browser';
import { createTextMaskInputElement } from 'text-mask-core/dist/textMaskCore';
import { mask, clean } from './utils';
var TextMaskConfig = /** @class */ (function () {
    function TextMaskConfig() {
    }
    return TextMaskConfig;
}());
export { TextMaskConfig };
if (false) {
    /** @type {?} */
    TextMaskConfig.prototype.mask;
    /** @type {?} */
    TextMaskConfig.prototype.guide;
    /** @type {?} */
    TextMaskConfig.prototype.placeholderChar;
    /** @type {?} */
    TextMaskConfig.prototype.pipe;
    /** @type {?} */
    TextMaskConfig.prototype.keepCharPositions;
    /** @type {?} */
    TextMaskConfig.prototype.showMask;
}
/**
 * We must check whether the agent is Android because composition events
 * behave differently between iOS and Android.
 * @return {?}
 */
function _isAndroid() {
    /** @type {?} */
    var userAgent = getDOM() ? getDOM().getUserAgent() : '';
    return /android (\d+)/.test(userAgent.toLowerCase());
}
var NgxPhoneMaskDirective = /** @class */ (function () {
    function NgxPhoneMaskDirective(_renderer, _elementRef, _compositionMode) {
        this._renderer = _renderer;
        this._elementRef = _elementRef;
        this._compositionMode = _compositionMode;
        this.clean = true;
        this.maxNumberLength = 13;
        /**
         * Whether the user is creating a composition string (IME events).
         */
        this._composing = false;
        this.onChange = function (_) {
        };
        this.onTouched = function () {
        };
        if (this._compositionMode == null) {
            this._compositionMode = !_isAndroid();
        }
    }
    /**
     * @return {?}
     */
    NgxPhoneMaskDirective.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        this._setupMask(true);
        if (this.textMaskInputElement !== undefined) {
            this.textMaskInputElement.update(this.inputElement.value);
        }
    };
    /**
     * @param {?} changes
     * @return {?}
     */
    NgxPhoneMaskDirective.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        this._setupMask(true);
        if (this.textMaskInputElement !== undefined) {
            this.textMaskInputElement.update(this.inputElement.value);
        }
    };
    /**
     * @return {?}
     */
    NgxPhoneMaskDirective.prototype.onBlur = /**
     * @return {?}
     */
    function () {
        this.onTouched();
    };
    /**
     * @param {?} value
     * @return {?}
     */
    NgxPhoneMaskDirective.prototype.writeValue = /**
     * @param {?} value
     * @return {?}
     */
    function (value) {
        this._setupMask();
        // set the initial value for cases where the mask is disabled
        /** @type {?} */
        var normalizedValue = value == null ? '' : value;
        this._renderer.setProperty(this.inputElement, 'value', normalizedValue);
        if (this.textMaskInputElement !== undefined) {
            this.textMaskInputElement.update(value);
        }
    };
    /**
     * @param {?} fn
     * @return {?}
     */
    NgxPhoneMaskDirective.prototype.registerOnChange = /**
     * @param {?} fn
     * @return {?}
     */
    function (fn) {
        this.onChange = fn;
    };
    /**
     * @param {?} fn
     * @return {?}
     */
    NgxPhoneMaskDirective.prototype.registerOnTouched = /**
     * @param {?} fn
     * @return {?}
     */
    function (fn) {
        this.onTouched = fn;
    };
    /**
     * @param {?} isDisabled
     * @return {?}
     */
    NgxPhoneMaskDirective.prototype.setDisabledState = /**
     * @param {?} isDisabled
     * @return {?}
     */
    function (isDisabled) {
        this._renderer.setProperty(this._elementRef.nativeElement, 'disabled', isDisabled);
    };
    /**
     * @param {?} value
     * @return {?}
     */
    NgxPhoneMaskDirective.prototype._handleInput = /**
     * @param {?} value
     * @return {?}
     */
    function (value) {
        if (!this._compositionMode || (this._compositionMode && !this._composing)) {
            this._setupMask();
            if (this.textMaskInputElement !== undefined) {
                this.textMaskInputElement.update(value);
                // get the updated value
                value = this.inputElement.value;
                if (this.clean) {
                    this.onChange(clean(value));
                }
                else {
                    this.onChange(value);
                }
            }
        }
    };
    /**
     * @param {?=} create
     * @return {?}
     */
    NgxPhoneMaskDirective.prototype._setupMask = /**
     * @param {?=} create
     * @return {?}
     */
    function (create) {
        if (create === void 0) { create = false; }
        this.textMaskConfig = {
            mask: mask(this.maxNumberLength),
            guide: false,
            placeholderChar: '_',
            pipe: undefined,
            keepCharPositions: false,
        };
        if (!this.inputElement) {
            if (this._elementRef.nativeElement.tagName.toUpperCase() === 'INPUT') {
                // `textMask` directive is used directly on an input element
                this.inputElement = this._elementRef.nativeElement;
            }
            else {
                // `textMask` directive is used on an abstracted input element, `md-input-container`, etc
                this.inputElement = this._elementRef.nativeElement.getElementsByTagName('INPUT')[0];
            }
        }
        if (this.inputElement && create) {
            this.textMaskInputElement = createTextMaskInputElement(Object.assign({ inputElement: this.inputElement }, this.textMaskConfig));
        }
    };
    /**
     * @return {?}
     */
    NgxPhoneMaskDirective.prototype._compositionStart = /**
     * @return {?}
     */
    function () {
        this._composing = true;
    };
    /**
     * @param {?} value
     * @return {?}
     */
    NgxPhoneMaskDirective.prototype._compositionEnd = /**
     * @param {?} value
     * @return {?}
     */
    function (value) {
        this._composing = false;
        this._compositionMode && this._handleInput(value);
    };
    NgxPhoneMaskDirective.decorators = [
        { type: Directive, args: [{
                    host: {
                        '(input)': '_handleInput($event.target.value)',
                        '(blur)': 'onTouched()',
                        '(compositionstart)': '_compositionStart()',
                        '(compositionend)': '_compositionEnd($event.target.value)'
                    },
                    selector: '[ngxPhoneMask]',
                    exportAs: 'ngxPhoneMask',
                    providers: [{
                            provide: NG_VALUE_ACCESSOR,
                            useExisting: forwardRef(function () { return NgxPhoneMaskDirective; }),
                            multi: true
                        }]
                },] }
    ];
    /** @nocollapse */
    NgxPhoneMaskDirective.ctorParameters = function () { return [
        { type: Renderer2 },
        { type: ElementRef },
        { type: Boolean, decorators: [{ type: Optional }, { type: Inject, args: [COMPOSITION_BUFFER_MODE,] }] }
    ]; };
    NgxPhoneMaskDirective.propDecorators = {
        clean: [{ type: Input }],
        maxNumberLength: [{ type: Input }],
        onBlur: [{ type: HostListener, args: ['blur',] }]
    };
    return NgxPhoneMaskDirective;
}());
export { NgxPhoneMaskDirective };
if (false) {
    /** @type {?} */
    NgxPhoneMaskDirective.prototype.clean;
    /** @type {?} */
    NgxPhoneMaskDirective.prototype.maxNumberLength;
    /** @type {?} */
    NgxPhoneMaskDirective.prototype.textMaskConfig;
    /**
     * @type {?}
     * @private
     */
    NgxPhoneMaskDirective.prototype.textMaskInputElement;
    /**
     * @type {?}
     * @private
     */
    NgxPhoneMaskDirective.prototype.inputElement;
    /**
     * Whether the user is creating a composition string (IME events).
     * @type {?}
     * @private
     */
    NgxPhoneMaskDirective.prototype._composing;
    /** @type {?} */
    NgxPhoneMaskDirective.prototype.onChange;
    /** @type {?} */
    NgxPhoneMaskDirective.prototype.onTouched;
    /**
     * @type {?}
     * @private
     */
    NgxPhoneMaskDirective.prototype._renderer;
    /**
     * @type {?}
     * @private
     */
    NgxPhoneMaskDirective.prototype._elementRef;
    /**
     * @type {?}
     * @private
     */
    NgxPhoneMaskDirective.prototype._compositionMode;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXBob25lLW1hc2suZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LXBob25lLW1hc2svIiwic291cmNlcyI6WyJsaWIvbmd4LXBob25lLW1hc2suZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQ04sU0FBUyxFQUNULFVBQVUsRUFDVixVQUFVLEVBQUUsWUFBWSxFQUN4QixNQUFNLEVBQUUsS0FBSyxFQUViLFFBQVEsRUFDUixTQUFTLEVBRVQsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGlCQUFpQixFQUF3Qix1QkFBdUIsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2xHLE9BQU8sRUFBRSxPQUFPLElBQUksTUFBTSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDOUQsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDOUUsT0FBTyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFdEM7SUFBQTtJQU9BLENBQUM7SUFBRCxxQkFBQztBQUFELENBQUMsQUFQRCxJQU9DOzs7O0lBTkEsOEJBQWlGOztJQUNqRiwrQkFBZ0I7O0lBQ2hCLHlDQUF5Qjs7SUFDekIsOEJBQW1GOztJQUNuRiwyQ0FBNEI7O0lBQzVCLGtDQUFtQjs7Ozs7OztBQU9wQixTQUFTLFVBQVU7O1FBQ1osU0FBUyxHQUFHLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRTtJQUN6RCxPQUFPLGVBQWUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7QUFDdEQsQ0FBQztBQUVEO0lBZ0NDLCtCQUNTLFNBQW9CLEVBQ3BCLFdBQXVCLEVBQ3NCLGdCQUF5QjtRQUZ0RSxjQUFTLEdBQVQsU0FBUyxDQUFXO1FBQ3BCLGdCQUFXLEdBQVgsV0FBVyxDQUFZO1FBQ3NC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ekIsSUFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7UUFDeEIsSUFBSSxDQUFDLGdCQUFnQixJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbkQsQ0FBQzs7Z0JBeklELFNBQVMsU0FBQztvQkFDVixJQUFJLEVBQUU7d0JBQ0wsU0FBUyxFQUFFLG1DQUFtQzt3QkFDOUMsUUFBUSxFQUFFLGFBQWE7d0JBQ3ZCLG9CQUFvQixFQUFFLHFCQUFxQjt3QkFDM0Msa0JBQWtCLEVBQUUsc0NBQXNDO3FCQUMxRDtvQkFDRCxRQUFRLEVBQUUsZ0JBQWdCO29CQUMxQixRQUFRLEVBQUUsY0FBYztvQkFDeEIsU0FBUyxFQUFFLENBQUM7NEJBQ1gsT0FBTyxFQUFFLGlCQUFpQjs0QkFDMUIsV0FBVyxFQUFFLFVBQVUsQ0FBQyxjQUFNLE9BQUEscUJBQXFCLEVBQXJCLENBQXFCLENBQUM7NEJBQ3BELEtBQUssRUFBRSxJQUFJO3lCQUNYLENBQUM7aUJBQ0Y7Ozs7Z0JBeENBLFNBQVM7Z0JBTFQsVUFBVTs4Q0FrRVIsUUFBUSxZQUFJLE1BQU0sU0FBQyx1QkFBdUI7Ozt3QkFuQjNDLEtBQUs7a0NBQ0wsS0FBSzt5QkF1Q0wsWUFBWSxTQUFDLE1BQU07O0lBa0ZyQiw0QkFBQztDQUFBLEFBMUlELElBMElDO1NBM0hZLHFCQUFxQjs7O0lBQ2pDLHNDQUFzQjs7SUFDdEIsZ0RBQXNDOztJQUV0QywrQ0FBK0I7Ozs7O0lBRS9CLHFEQUFrQzs7Ozs7SUFDbEMsNkNBQXVDOzs7Ozs7SUFHdkMsMkNBQTJCOztJQUUzQix5Q0FDRTs7SUFDRiwwQ0FDRTs7Ozs7SUFHRCwwQ0FBNEI7Ozs7O0lBQzVCLDRDQUErQjs7Ozs7SUFDL0IsaURBQThFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcblx0RGlyZWN0aXZlLFxuXHRFbGVtZW50UmVmLFxuXHRmb3J3YXJkUmVmLCBIb3N0TGlzdGVuZXIsXG5cdEluamVjdCwgSW5wdXQsXG5cdE9uQ2hhbmdlcywgT25Jbml0LFxuXHRPcHRpb25hbCxcblx0UmVuZGVyZXIyLFxuXHRTaW1wbGVDaGFuZ2VzXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTkdfVkFMVUVfQUNDRVNTT1IsIENvbnRyb2xWYWx1ZUFjY2Vzc29yLCBDT01QT1NJVElPTl9CVUZGRVJfTU9ERSB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IMm1Z2V0RE9NIGFzIGdldERPTSB9IGZyb20gJ0Bhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXInO1xuaW1wb3J0IHsgY3JlYXRlVGV4dE1hc2tJbnB1dEVsZW1lbnQgfSBmcm9tICd0ZXh0LW1hc2stY29yZS9kaXN0L3RleHRNYXNrQ29yZSc7XG5pbXBvcnQgeyBtYXNrLCBjbGVhbiB9IGZyb20gJy4vdXRpbHMnO1xuXG5leHBvcnQgY2xhc3MgVGV4dE1hc2tDb25maWcge1xuXHRtYXNrOiBBcnJheTxzdHJpbmcgfCBSZWdFeHA+IHwgKChyYXc6IHN0cmluZykgPT4gQXJyYXk8c3RyaW5nIHwgUmVnRXhwPikgfCBmYWxzZTtcblx0Z3VpZGU/OiBib29sZWFuO1xuXHRwbGFjZWhvbGRlckNoYXI/OiBzdHJpbmc7XG5cdHBpcGU/OiAoY29uZm9ybWVkVmFsdWU6IHN0cmluZywgY29uZmlnOiBUZXh0TWFza0NvbmZpZykgPT4gZmFsc2UgfCBzdHJpbmcgfCBvYmplY3Q7XG5cdGtlZXBDaGFyUG9zaXRpb25zPzogYm9vbGVhbjtcblx0c2hvd01hc2s/OiBib29sZWFuO1xufVxuXG4vKipcbiAqIFdlIG11c3QgY2hlY2sgd2hldGhlciB0aGUgYWdlbnQgaXMgQW5kcm9pZCBiZWNhdXNlIGNvbXBvc2l0aW9uIGV2ZW50c1xuICogYmVoYXZlIGRpZmZlcmVudGx5IGJldHdlZW4gaU9TIGFuZCBBbmRyb2lkLlxuICovXG5mdW5jdGlvbiBfaXNBbmRyb2lkKCk6IGJvb2xlYW4ge1xuXHRjb25zdCB1c2VyQWdlbnQgPSBnZXRET00oKSA/IGdldERPTSgpLmdldFVzZXJBZ2VudCgpIDogJyc7XG5cdHJldHVybiAvYW5kcm9pZCAoXFxkKykvLnRlc3QodXNlckFnZW50LnRvTG93ZXJDYXNlKCkpO1xufVxuXG5ARGlyZWN0aXZlKHtcblx0aG9zdDoge1xuXHRcdCcoaW5wdXQpJzogJ19oYW5kbGVJbnB1dCgkZXZlbnQudGFyZ2V0LnZhbHVlKScsXG5cdFx0JyhibHVyKSc6ICdvblRvdWNoZWQoKScsXG5cdFx0Jyhjb21wb3NpdGlvbnN0YXJ0KSc6ICdfY29tcG9zaXRpb25TdGFydCgpJyxcblx0XHQnKGNvbXBvc2l0aW9uZW5kKSc6ICdfY29tcG9zaXRpb25FbmQoJGV2ZW50LnRhcmdldC52YWx1ZSknXG5cdH0sXG5cdHNlbGVjdG9yOiAnW25neFBob25lTWFza10nLFxuXHRleHBvcnRBczogJ25neFBob25lTWFzaycsXG5cdHByb3ZpZGVyczogW3tcblx0XHRwcm92aWRlOiBOR19WQUxVRV9BQ0NFU1NPUixcblx0XHR1c2VFeGlzdGluZzogZm9yd2FyZFJlZigoKSA9PiBOZ3hQaG9uZU1hc2tEaXJlY3RpdmUpLFxuXHRcdG11bHRpOiB0cnVlXG5cdH1dXG59KVxuZXhwb3J0IGNsYXNzIE5neFBob25lTWFza0RpcmVjdGl2ZSBpbXBsZW1lbnRzIENvbnRyb2xWYWx1ZUFjY2Vzc29yLCBPbkNoYW5nZXMsIE9uSW5pdCB7XG5cdEBJbnB1dCgpIGNsZWFuID0gdHJ1ZTtcblx0QElucHV0KCkgbWF4TnVtYmVyTGVuZ3RoOiBudW1iZXIgPSAxMztcblxuXHR0ZXh0TWFza0NvbmZpZzogVGV4dE1hc2tDb25maWc7XG5cblx0cHJpdmF0ZSB0ZXh0TWFza0lucHV0RWxlbWVudDogYW55O1xuXHRwcml2YXRlIGlucHV0RWxlbWVudDogSFRNTElucHV0RWxlbWVudDtcblxuXHQvKiogV2hldGhlciB0aGUgdXNlciBpcyBjcmVhdGluZyBhIGNvbXBvc2l0aW9uIHN0cmluZyAoSU1FIGV2ZW50cykuICovXG5cdHByaXZhdGUgX2NvbXBvc2luZyA9IGZhbHNlO1xuXG5cdG9uQ2hhbmdlID0gKF86IGFueSkgPT4ge1xuXHR9O1xuXHRvblRvdWNoZWQgPSAoKSA9PiB7XG5cdH07XG5cblx0Y29uc3RydWN0b3IoXG5cdFx0cHJpdmF0ZSBfcmVuZGVyZXI6IFJlbmRlcmVyMixcblx0XHRwcml2YXRlIF9lbGVtZW50UmVmOiBFbGVtZW50UmVmLFxuXHRcdEBPcHRpb25hbCgpIEBJbmplY3QoQ09NUE9TSVRJT05fQlVGRkVSX01PREUpIHByaXZhdGUgX2NvbXBvc2l0aW9uTW9kZTogYm9vbGVhblxuXHQpIHtcblx0XHRpZiAodGhpcy5fY29tcG9zaXRpb25Nb2RlID09IG51bGwpIHtcblx0XHRcdHRoaXMuX2NvbXBvc2l0aW9uTW9kZSA9ICFfaXNBbmRyb2lkKCk7XG5cdFx0fVxuXHR9XG5cblx0bmdPbkluaXQoKSB7XG5cdFx0dGhpcy5fc2V0dXBNYXNrKHRydWUpO1xuXHRcdGlmICh0aGlzLnRleHRNYXNrSW5wdXRFbGVtZW50ICE9PSB1bmRlZmluZWQpIHtcblx0XHRcdHRoaXMudGV4dE1hc2tJbnB1dEVsZW1lbnQudXBkYXRlKHRoaXMuaW5wdXRFbGVtZW50LnZhbHVlKTtcblx0XHR9XG5cdH1cblxuXHRuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG5cdFx0dGhpcy5fc2V0dXBNYXNrKHRydWUpO1xuXHRcdGlmICh0aGlzLnRleHRNYXNrSW5wdXRFbGVtZW50ICE9PSB1bmRlZmluZWQpIHtcblx0XHRcdHRoaXMudGV4dE1hc2tJbnB1dEVsZW1lbnQudXBkYXRlKHRoaXMuaW5wdXRFbGVtZW50LnZhbHVlKTtcblx0XHR9XG5cdH1cblxuXHRASG9zdExpc3RlbmVyKCdibHVyJylcblx0b25CbHVyKCkge1xuXHRcdHRoaXMub25Ub3VjaGVkKCk7XG5cdH1cblxuXHR3cml0ZVZhbHVlKHZhbHVlOiBhbnkpIHtcblx0XHR0aGlzLl9zZXR1cE1hc2soKTtcblxuXHRcdC8vIHNldCB0aGUgaW5pdGlhbCB2YWx1ZSBmb3IgY2FzZXMgd2hlcmUgdGhlIG1hc2sgaXMgZGlzYWJsZWRcblx0XHRjb25zdCBub3JtYWxpemVkVmFsdWUgPSB2YWx1ZSA9PSBudWxsID8gJycgOiB2YWx1ZTtcblx0XHR0aGlzLl9yZW5kZXJlci5zZXRQcm9wZXJ0eSh0aGlzLmlucHV0RWxlbWVudCwgJ3ZhbHVlJywgbm9ybWFsaXplZFZhbHVlKTtcblxuXHRcdGlmICh0aGlzLnRleHRNYXNrSW5wdXRFbGVtZW50ICE9PSB1bmRlZmluZWQpIHtcblx0XHRcdHRoaXMudGV4dE1hc2tJbnB1dEVsZW1lbnQudXBkYXRlKHZhbHVlKTtcblx0XHR9XG5cdH1cblxuXHRyZWdpc3Rlck9uQ2hhbmdlKGZuOiAoXzogYW55KSA9PiB2b2lkKTogdm9pZCB7XG5cdFx0dGhpcy5vbkNoYW5nZSA9IGZuO1xuXHR9XG5cblx0cmVnaXN0ZXJPblRvdWNoZWQoZm46ICgpID0+IHZvaWQpOiB2b2lkIHtcblx0XHR0aGlzLm9uVG91Y2hlZCA9IGZuO1xuXHR9XG5cblx0c2V0RGlzYWJsZWRTdGF0ZShpc0Rpc2FibGVkOiBib29sZWFuKTogdm9pZCB7XG5cdFx0dGhpcy5fcmVuZGVyZXIuc2V0UHJvcGVydHkodGhpcy5fZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCAnZGlzYWJsZWQnLCBpc0Rpc2FibGVkKTtcblx0fVxuXG5cdF9oYW5kbGVJbnB1dCh2YWx1ZSkge1xuXHRcdGlmICghdGhpcy5fY29tcG9zaXRpb25Nb2RlIHx8ICh0aGlzLl9jb21wb3NpdGlvbk1vZGUgJiYgIXRoaXMuX2NvbXBvc2luZykpIHtcblx0XHRcdHRoaXMuX3NldHVwTWFzaygpO1xuXG5cdFx0XHRpZiAodGhpcy50ZXh0TWFza0lucHV0RWxlbWVudCAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdHRoaXMudGV4dE1hc2tJbnB1dEVsZW1lbnQudXBkYXRlKHZhbHVlKTtcblxuXHRcdFx0XHQvLyBnZXQgdGhlIHVwZGF0ZWQgdmFsdWVcblx0XHRcdFx0dmFsdWUgPSB0aGlzLmlucHV0RWxlbWVudC52YWx1ZTtcblxuXHRcdFx0XHRpZiAodGhpcy5jbGVhbikge1xuXHRcdFx0XHRcdHRoaXMub25DaGFuZ2UoY2xlYW4odmFsdWUpKTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHR0aGlzLm9uQ2hhbmdlKHZhbHVlKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdF9zZXR1cE1hc2soY3JlYXRlID0gZmFsc2UpIHtcblx0XHR0aGlzLnRleHRNYXNrQ29uZmlnID0ge1xuXHRcdFx0bWFzazogbWFzayh0aGlzLm1heE51bWJlckxlbmd0aCksXG5cdFx0XHRndWlkZTogZmFsc2UsXG5cdFx0XHRwbGFjZWhvbGRlckNoYXI6ICdfJyxcblx0XHRcdHBpcGU6IHVuZGVmaW5lZCxcblx0XHRcdGtlZXBDaGFyUG9zaXRpb25zOiBmYWxzZSxcblx0XHR9O1xuXHRcdGlmICghdGhpcy5pbnB1dEVsZW1lbnQpIHtcblx0XHRcdGlmICh0aGlzLl9lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQudGFnTmFtZS50b1VwcGVyQ2FzZSgpID09PSAnSU5QVVQnKSB7XG5cdFx0XHRcdC8vIGB0ZXh0TWFza2AgZGlyZWN0aXZlIGlzIHVzZWQgZGlyZWN0bHkgb24gYW4gaW5wdXQgZWxlbWVudFxuXHRcdFx0XHR0aGlzLmlucHV0RWxlbWVudCA9IHRoaXMuX2VsZW1lbnRSZWYubmF0aXZlRWxlbWVudDtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdC8vIGB0ZXh0TWFza2AgZGlyZWN0aXZlIGlzIHVzZWQgb24gYW4gYWJzdHJhY3RlZCBpbnB1dCBlbGVtZW50LCBgbWQtaW5wdXQtY29udGFpbmVyYCwgZXRjXG5cdFx0XHRcdHRoaXMuaW5wdXRFbGVtZW50ID0gdGhpcy5fZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdJTlBVVCcpWzBdO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdGlmICh0aGlzLmlucHV0RWxlbWVudCAmJiBjcmVhdGUpIHtcblx0XHRcdHRoaXMudGV4dE1hc2tJbnB1dEVsZW1lbnQgPSBjcmVhdGVUZXh0TWFza0lucHV0RWxlbWVudChcblx0XHRcdFx0T2JqZWN0LmFzc2lnbih7IGlucHV0RWxlbWVudDogdGhpcy5pbnB1dEVsZW1lbnQgfSwgdGhpcy50ZXh0TWFza0NvbmZpZylcblx0XHRcdCk7XG5cdFx0fVxuXG5cdH1cblxuXHRfY29tcG9zaXRpb25TdGFydCgpOiB2b2lkIHtcblx0XHR0aGlzLl9jb21wb3NpbmcgPSB0cnVlO1xuXHR9XG5cblx0X2NvbXBvc2l0aW9uRW5kKHZhbHVlOiBhbnkpOiB2b2lkIHtcblx0XHR0aGlzLl9jb21wb3NpbmcgPSBmYWxzZTtcblx0XHR0aGlzLl9jb21wb3NpdGlvbk1vZGUgJiYgdGhpcy5faGFuZGxlSW5wdXQodmFsdWUpO1xuXHR9XG59XG4iXX0=